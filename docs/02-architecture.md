# 2. Архитектура

## Слои

```
┌─────────────────────────────────────────────────────────────┐
│                    Telegram API                              │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Telegram Layer (Telegraf)                       │
│  • Команды (/start, /help, /date, /dates, /wish, и т.д.)     │
│  • FSM/Scenes (addWish, addDate, selectRole)                 │
│  • Reply-клавиатура, inline-кнопки                           │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Middleware                                      │
│  • session (Telegraf)                                        │
│  • whitelistMiddleware — проверка доступа, создание user     │
│  • stage — FSM-сцены                                         │
│  • pendingRoleRedirect — редирект в выбор роли               │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Business Logic (services)                       │
│  • userService — пользователи, роли                          │
│  • noteService — заметки/пожелания                           │
│  • dateService — важные даты, логика напоминаний             │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│              Persistence (SQLite)                            │
│  • users, notes, important_dates, reminder_logs              │
└─────────────────────────────────────────────────────────────┘
                              │
┌─────────────────────────────────────────────────────────────┐
│              Scheduler (node-cron)                           │
│  • 09:00 — напоминания о датах                               │
│  • 12:00 — случайное пожелание партнёра                      │
└─────────────────────────────────────────────────────────────┘
```

## Порядок middleware (критично)

1. **session** — загрузка сессии
2. **whitelistMiddleware** — проверка whitelist, установка `ctx.state.user` или `ctx.state.pendingRoleSelection`
3. **stage** — обработка FSM-сцен (добавляет `ctx.scene`)
4. **pendingRoleRedirect** — при `pendingRoleSelection` переводит в сцену выбора роли
5. **Команды** — /start, /help, /date, /dates, /wish, /wishes, /my_notes

> Важно: whitelist должен быть **до** stage, иначе в сценах `ctx.state.user` будет `undefined`.

## Потоки

### Старт нового пользователя (не owner)

1. Пользователь отправляет /start
2. whitelist → `pendingRoleSelection = telegramId`
3. stage → пропускает (пользователь не в сцене)
4. pendingRoleRedirect → `ctx.scene.enter('SELECT_ROLE')`
5. Сцена selectRoleScene → «Кто вы в паре?» → кнопка «Партнёр»
6. Пользователь нажимает → `createUserWithRole(telegramId, 'PARTNER')` → меню партнёра

### Добавление даты (OWNER)

1. Команда /date или кнопка «Добавить дату»
2. addDateScene: title → date → reminder_type (yearly/once) → remind_before_days
3. `addImportantDate()` → сохранение в БД
4. Подтверждение + возврат главной клавиатуры

### Добавление пожелания (PARTNER)

1. Команда /wish или кнопка «Добавить пожелание»
2. addWishScene: ввод текста
3. `addNote()` → сохранение
4. Подтверждение

### Cron-напоминания

- **Даты**: каждый день в 09:00 — выбор дат, у которых «сегодня» = (дата − remind_before_days) или сама дата
- **Случайное**: каждый день в 12:00 — случайная заметка партнёра (исключая недавние)
